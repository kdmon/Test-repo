<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clinical vignette</title>
  <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Just+Another+Hand' rel='stylesheet' type='text/css'>
  <script src="/jwarby/jquery-awesome-cursor/master/dist/jquery.awesome-cursor.min.js"></script>
  <style type='text/css'>
  .badgebackground {
    border-radius: 20px;
    padding: 5px;
    margin: 5px;
    background-image: url("http://optimalblooduse.eu/app/badges/bg.png");
  }

.badge {
    width: 6em;
    opacity: 0.1;
    margin: 10px;
    border-radius: 10px;
    
}

.largebadge {
    width: 50%;
    max-width: 512px;
    opacity: 1;
    border-radius: 15px;
    margin: 9px;
    border: 1px solid #444;
    box-shadow: 10px 10px 5px rgba(0,0,0,0.5);
}

.badge:hover {
    width: 6em;
    opacity: .2;
    margin: 9px;
    border: 1px solid #aaa;
    box-shadow: 10px 10px 5px rgba(0,0,0,0.5);
}

.earned, .earned:hover {
    opacity: 1;
    
}

.level {
    cursor: pointer;
    float: left;
    display: block;
    padding: 50px;
    font-size: 6em;
    border-radius: 10px;
    text-align: middle;
    background: #aaa no-repeat;
    margin: 10px;
    background-size: contain;
}

.current {
    background: #da0 no-repeat;
}

.threestars {
    background: #4a4 no-repeat;
    background-image: url("http://optimalblooduse.eu/app/badges/threestars.png");
    background-size: contain;
}


.twostars {
    background: #4a4 no-repeat;
    background-image: url("http://optimalblooduse.eu/app/badges/twostars.png");
    background-size: contain;
}

.onestar {
    background: #4a4 no-repeat;
    background-image: url("http://optimalblooduse.eu/app/badges/onestar.png");
    background-size: contain;
}

.nostars {
    background: #4a4 no-repeat;
    background-image: url("http://optimalblooduse.eu/app/badges/nostars.png");
    background-size: contain;
}

.handwritten {
  font-family: 'Just Another Hand', cursive;
  padding-left: 4px;
  padding-top: 8px;
  padding-bottom: 0;
  border: 1px solid #ddd;
  color: blue;;
  font-weight: 400;
  font-size: 2em;
  width: 100%;
  display: inline-block;
  border-radius: 4px;
  background: white;
  font-weight: 400 !important;
}

#request-form {
  position: relative;
  top: 1em;
  left: 0.5em;
  background: #fee;
  background: url("pink_rice.png");
  border-radius: 0 0 90px 12px / 0 0 6px 116px;
  box-shadow: 0 -8px 20px rgba(0,0,0,.15), 19px -30px 120px rgb(225, 218, 218) inset;
  color: #555;
  padding: 1em;
  max-width: 48em;
  margin: -6em auto 0 auto;
  transform: rotate(0deg);
  opacity: 0.98;
}

#request-form:hover {
  box-shadow: 0 12px 50px rgba(0,0,0,.35), 19px -30px 50px rgb(225, 218, 218) inset;
  top: 0.8em;
}



.request-section {
  border-radius: 4px;
  padding: 1em;
  margin: 0em;
  margin-bottom: 1em;
  vertical-align: top;
  background: rgba(255,255,255,0.4);
  min-height: 32em;
}

.split {
  width: 43%;
  display: inline-block;
}

.blurred {
  filter: blur(0px); 
  -webkit-filter: blur(0px);
}

.blurred span {
  font-size: 2em !important;
}

.portrait {
  margin: 0 0.5em 1em 0em;
  max-height: 8em;
  float: left; 
  border-radius: 7px;
  filter: blur(1px) sepia(100%); 
  -webkit-filter: blur(1px) sepia(100%); 
  border: 1px solid #ddd;
}

.pencil, .pencil > * {
  cursor: url('pen_64.ico'), auto !important;	
  margin: 0 !important;
}

.white {
  padding: 0.5em;
  margin-bottom: 0.5em;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: white;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.highlighted {
  margin: 0.25em 0 0.25em 0;
  text-align: center;
  color: black;
  background: #FFc;
  padding: 0.5em;
  border: 1px solid #ddd;
}

.submit-button {
  padding: 0;
  cursor: pointer;
  margin: 1em 0 0 0;
  font-size: 2em;
  background: #Fff;
  border: 1px solid #ddd;
  border-bottom: 2px dotted black;
  border-radius: 4px 4px 0 0;
}

.submit-button:hover {
  background: #fff;
}

.clip {
    position: absolute;
    width: 300px;
    left: 45%;
    z-index: 18;
    top: 2.8em;
    transform: rotate(2deg);
}


/* Custom Icons For Checkbox */
label {
  text-align: left;
  color: black;
  margin:5px 0;
  padding: 0.5em;
  position:relative;
  font-size:30px;
  -webkit-transition:.2s linear;
  -moz-transition:.2s linear;
  -o-transition:.2s linear;
  transition:.2s linear
}

label:before,label:after {
    content:'';
    right:11px;
    width:3px;
    bottom:0;
    background: blue;
    position:absolute;
    top:0;
}

label:before {
    transform:rotate(45deg);
    transform-origin:0 14px;
    height:0;
    -webkit-transition:.2s linear;
    -moz-transition:.2s linear;
    -o-transition:.2s linear;
    transition:.2s linear
}

label:after {
    transform:rotate(-45deg);
    transform-origin:0 20px;
    height:0;
    -webkit-transition:.2s linear .2s;
    -moz-transition:.2s linear .2s;
    -o-transition:.2s linear .2s;
    transition:.2s linear .2s
}

input[type="checkbox"] {
    display:none
}

input[type="checkbox"]:checked + label:after,input[type="checkbox"]:checked + label:before {
    height:100%;
}

input[type="checkbox"]:checked + label {
    font-weight: 800;
}

.patient-record {
  background: url("cork-wallet.png");
  padding: 1.25em 1em 6em 1em; 
  max-width: 34em; 
  min-height: 7em;
  margin: 2em auto 0 auto;
  transform: rotate(2deg);
  position: relative;
  top: 0;
  left: 1em;
}

.patient-record:hover {
  box-shadow: 0 10px 15px 0 rgba(0,0,0,0.15);
  z-index: 10;
  opacity: 0.98;
  cursor: help;
} 

.box-border {
  width: 2em;
  height: 2.2em;
  background: #fee;
  float: right;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.postit-container {
  display: block;
  position: absolute;
  right: 1em;
  bottom: -8em;
}

.postit {
  width: 170px;
  height: 100px;
  padding: 1em;
  margin: 1em;
  z-index: 2;
  position: relative;   
  border: 1px solid #E8E8E8;
  border-top: 0em solid #FFFFCC;
  border-bottom-right-radius: 60px 5px;
  display:inline-block;    
  background: #ffff88; /* Old browsers */
  background: linear-gradient(135deg, #ffff88 81%,#ffff88 82%,#ffff88 82%,#ffffc6 100%); /* W3C */
}

.cornershadow {     
  content: "";
  position: relative;
  z-index: 1;
  right:-20px;
  bottom: 55px;
  width:200px;
  height: 25px;
  background: rgba(0, 0, 0, 0.2);
  box-shadow:2px 15px 5px rgba(0, 0, 0, 0.40);
  -moz-transform: matrix(-1, -0.1, 0, 1, 0, 0);
   -webkit-transform: matrix(-1, -0.1, 0, 1, 0, 0);
        -o-transform: matrix(-1, -0.1, 0, 1, 0, 0);
       -ms-transform: matrix(-1, -0.1, 0, 1, 0, 0);
           transform: matrix(-1, -0.1, 0, 1, 0, 0);
}

.board {
  background: url("wood.jpg");
  max-width: 51em;
  min-height: 60em;
  margin: 7em auto 4em auto;
  border-radius: 1em;
  padding-right: 1em;
  padding-left: 0.5em;
}

.container {
  max-height: 1.2em;
  margin: 0 auto;
}

.faded-signature {
  width: 165px;
  opacity: 0.2;
  display: none;
}

.signature {
  position: relative;
  min-width: 165px;
  height: 0;
  padding-bottom: 1.5em;
  opacity: 0.6;
}

.signature svg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}



@media (max-width: 600px) {

  body {font-size: 0.9em;}
      
  .board {
    margin-top: 3em;
  }
  .clip {
    width: 120px;
    top: 2.5em;
  }
  
  .part-two {
    display: none !important;
  }
  
  .patient-record {
    top: 0;
  }
  
  .split {
    width: 90%;
    display: inline-block;
  }
  
  .portrait {
    float: none;
    margin: auto;
    display: block;
  }
  
  
}


  </style>

</head>
<body>
  <div data-role="page" id="game">
    <div data-role="header" data-theme="a">
      <h1>Game</h1>
      <a data-role="button" href="#badges">Badges</a>
    </div>
    <div data-role="contents">
      <h1>Select level</h1>
      <div class="level threestars" id="level1">1</div>
      <div class="level  onestar" id="level2">2</div>
      <div class="level current" id="level3">3</div>
      <div class="level" id="level4">4</div>
      <div class="level" id="level5">5</div>
      <div class="level" id="level6">6</div>
    </div>
  </div>
  
  <div data-role="page" id="badges">
    <div data-role="header" data-theme="a">
      <h1>Badges</h1>
      <a data-role="button" href="#game">Game</a>
    </div>
    
    <div data-role="contents">
      <h1 style="text-align: center">Your Achievements</h1>
      <div id="container" class="badgebackground"></div>
    </div>
  </div>
  
  <div data-role="page" id="levels">
    <div data-role="header" data-theme="a">
      <h1 id="levelnumber">Patient vignettes</h1>
      <a data-role="button" href="#game">Back</a>
    </div>
    <div data-role="contents" style="margin: 1em">
    
      <div class="board">
          
        
        <img class="clip" src="clip2.png">
        <div class="patient-record">
          <div id="patientPortrait" style="transform:rotate(0deg);">Loading portrait</div>
          <div id="patientInfo"  style="transform:rotate(-2deg);">Loading info</div>
          <div class="postit-container">
            <div class="postit">
              <em>Hint: check any special requirements and sign the request form to verify your answers.</em>
            </div>
            <div class="cornershadow"></div>
          </div>
        </div>
      
        <div id="request-form" style="text-align:center">
          <h1 style="color: #e99; text-shadow: 1px 1px 5px #fff;">BLOOD REQUEST FORM</h1>
          <div class="request-section split">
            
            <h2> Components</h2>
            <p>Units: <span class="handwritten" id="bloodcomponent">.</span></p>
  
            
  
            <p style="margin-bottom: 0"> Special requirements: </p>
              
            <div class="white">
              <div class="box-border"></div>
              <input type="checkbox" data-role="none" name="irrad" id="irrad" />
              <label class="pencil" data-role="none" for="irrad">Irradiated</label>
            </div>
            
            <div class="white">
              <div class="box-border"></div>
              <input type="checkbox" data-role="none" name="cmvneg" id="cmvneg" />
              <label class="pencil" data-role="none" for="cmvneg">CMV negative</label>
            </div>
            
            <div class="white">
              <div class="box-border"></div>
              <input type="checkbox" data-role="none" name="hepe" id="hepe" />
              <label class="pencil" data-role="none" for="hepe">Hep-E negative</label>
            </div>
            
            <div class="highlighted">
            <h3> Sign to verify request</h3>
            <div class="pencil submit-button">
              <div class="container">
                <div class="faded-signature">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="34.924 351.353 548.489 159.86"><path fill="none" stroke="#0000ee"  stroke-width="8" stroke-linecap="round" stroke-linejoin="round" d="M51.494,355.859c-0.361,6.059-0.928,154.471,0.112,139.244"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M78.591,407.725c1.312,22.307-22.823,30.685-40.917,38.995v0.438c28.433,6.559,63.44,14.872,83.997,37.178"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M107.581,428.161c-10.663-3.553-25.783,30.933-12.163,31.759c9.906,0.412,10.873-18.834,13.134-26.911 c-5.65,11.058,3.828,48.292,20.075,6.995c-11.509,10.832,17.602,55.514,27.12-39.959c-2.612,27.794-5.091,45.328,6.053,56.885 c9.493,9.906,24.097,5.309,26.899-6.503c9.349-39.39,2.886-89.151-4.863-88.502c-7.76,0.648-12.929,44.588-4.217,79.835 c2.759,11.161,9.906,22.289,23.114,24.354c14.859,2.475,13.208-12.385,17.335-21.466c1.238,5.367,1.238,11.971,7.842,12.795 c7.429,1.238,9.492-9.906,14.446-9.906c2.063,0,4.127,4.129,6.192,4.541c3.302,1.238,3.715-0.412,7.017-1.651 c19.812-6.19,17.879-0.059,38.517-0.059"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M137.931,434.742c14.447-2.475,28.894-3.714,43.753-4.128"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M323.739,390.271c7.861-15.198-23.06-13.102-28.826-1.571c-13.101,26.204,37.734,46.643,44.023,68.653 c9.435,33.017-49.264,34.063-67.605,21.487c-11.53-8.386-2.096-13.626,8.385-16.771"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M355.25,448.722c-5.261,16.234,3.377,51.195,12.721,59.741c0,0,0.649-26.498-10.497-40.877"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M366.466,462.687c6.728,0.814,33.816,1.509,39.618-16.217c5.733-17.524-34.122-12.104-46.724-6.919 c-4.088,1.683-12.966,5.606-12.708,12.208c0.535,13.62,37.153,12.974,56.324,8.02s23.665-9.646,25.908-14.53 c-4.859,0.813-5.232,10.987-1.495,14.243c4.86,4.069,6.729-2.442,9.718-6.104c0.747,3.256,1.494,6.104,2.989,8.952 c3.738-2.848,5.608-10.173,10.841-9.766c4.485,0,3.991,5.186,8.477,5.594c4.111,0.408,8.078-11.094,22.939-10.447 c-8.399-1.615-24.232,8.725-13.569,12.278c11.309,2.907,13.178-9.46,14.674-14.343c1.494-5.29,6.729-39.826,0.748-43.896 c-4.485-2.849-5.232,5.696-5.607,9.359c-1.12,11.395,2.617,32.093,10.093,40.64c7.476,8.952,26.537,12.207,32.892-1.628 c4.861-10.986-8.597-17.498-10.091-5.289c-2.99,23.195,22.56,15.073,30.566,7.922c13.571-12.116,11.147-86.235,2.259-86.761 c-8.071-0.478-24.718,94.514,36.346,102.269"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M432.622,431.008c0.373-0.407,0.373-1.222,0.373-2.035"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M130.66,421.731c0.373-0.407,0.373-1.221,0.373-2.035"/></svg>
                </div>
                <div class="signature">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="34.924 351.353 548.489 159.86"><path fill="none" stroke="#0000ee"  stroke-width="8" stroke-linecap="round" stroke-linejoin="round" d="M51.494,355.859c-0.361,6.059-0.928,154.471,0.112,139.244"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M78.591,407.725c1.312,22.307-22.823,30.685-40.917,38.995v0.438c28.433,6.559,63.44,14.872,83.997,37.178"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M107.581,428.161c-10.663-3.553-25.783,30.933-12.163,31.759c9.906,0.412,10.873-18.834,13.134-26.911 c-5.65,11.058,3.828,48.292,20.075,6.995c-11.509,10.832,17.602,55.514,27.12-39.959c-2.612,27.794-5.091,45.328,6.053,56.885 c9.493,9.906,24.097,5.309,26.899-6.503c9.349-39.39,2.886-89.151-4.863-88.502c-7.76,0.648-12.929,44.588-4.217,79.835 c2.759,11.161,9.906,22.289,23.114,24.354c14.859,2.475,13.208-12.385,17.335-21.466c1.238,5.367,1.238,11.971,7.842,12.795 c7.429,1.238,9.492-9.906,14.446-9.906c2.063,0,4.127,4.129,6.192,4.541c3.302,1.238,3.715-0.412,7.017-1.651 c19.812-6.19,17.879-0.059,38.517-0.059"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M137.931,434.742c14.447-2.475,28.894-3.714,43.753-4.128"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M323.739,390.271c7.861-15.198-23.06-13.102-28.826-1.571c-13.101,26.204,37.734,46.643,44.023,68.653 c9.435,33.017-49.264,34.063-67.605,21.487c-11.53-8.386-2.096-13.626,8.385-16.771"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M355.25,448.722c-5.261,16.234,3.377,51.195,12.721,59.741c0,0,0.649-26.498-10.497-40.877"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M366.466,462.687c6.728,0.814,33.816,1.509,39.618-16.217c5.733-17.524-34.122-12.104-46.724-6.919 c-4.088,1.683-12.966,5.606-12.708,12.208c0.535,13.62,37.153,12.974,56.324,8.02s23.665-9.646,25.908-14.53 c-4.859,0.813-5.232,10.987-1.495,14.243c4.86,4.069,6.729-2.442,9.718-6.104c0.747,3.256,1.494,6.104,2.989,8.952 c3.738-2.848,5.608-10.173,10.841-9.766c4.485,0,3.991,5.186,8.477,5.594c4.111,0.408,8.078-11.094,22.939-10.447 c-8.399-1.615-24.232,8.725-13.569,12.278c11.309,2.907,13.178-9.46,14.674-14.343c1.494-5.29,6.729-39.826,0.748-43.896 c-4.485-2.849-5.232,5.696-5.607,9.359c-1.12,11.395,2.617,32.093,10.093,40.64c7.476,8.952,26.537,12.207,32.892-1.628 c4.861-10.986-8.597-17.498-10.091-5.289c-2.99,23.195,22.56,15.073,30.566,7.922c13.571-12.116,11.147-86.235,2.259-86.761 c-8.071-0.478-24.718,94.514,36.346,102.269"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M432.622,431.008c0.373-0.407,0.373-1.222,0.373-2.035"/><path fill="none" stroke="#0000ee"  stroke-width="7" stroke-linecap="round" stroke-linejoin="round" d="M130.66,421.731c0.373-0.407,0.373-1.221,0.373-2.035"/></svg>
                </div>
              </div>
            </div>
            </div>
          
            
          <script>
            (function () {
        window.signature = {
            initialize: function () {
                return $('.signature svg').each(function () {
                    var delay, i, len, length, path, paths, previousStrokeLength, results, speed;
                    paths = $('path, circle, rect', this);
                    delay = 0;
                    results = [];
                    for (i = 0, len = paths.length; i < len; i++) {
                        path = paths[i];
                        length = path.getTotalLength();
                        previousStrokeLength = speed || 0;
                        speed = length < 100 ? 20: Math.floor(length);
                        speed -= 75;
                        delay += previousStrokeLength + 100;
                        delay -= 150;
                        results.push($(path).css('transition', 'none').attr('data-length', length).attr('data-speed', speed).attr('data-delay', delay).attr('stroke-dashoffset', length).attr('stroke-dasharray', length + ',' + length));
                    }
                    return results;
                });
            },
            animate: function () {
                return $('.signature svg').each(function () {
                    var delay, i, len, length, path, paths, results, speed;
                    paths = $('path, circle, rect', this);
                    results = [];
                    for (i = 0, len = paths.length; i < len; i++) {
                        path = paths[i];
                        length = $(path).attr('data-length');
                        speed = $(path).attr('data-speed');
                        delay = $(path).attr('data-delay');
                        results.push($(path).css('transition', 'stroke-dashoffset ' + speed + 'ms ' + delay + 'ms linear').attr('stroke-dashoffset', '0'));
                    }
                    return results;
                });
            }
        };
        $(document).ready(function () {
          var checking = false;
            window.signature.initialize();
            /*
            $('.submit-button').on('mouseout', function () {
              window.signature.initialize();
            });
            $('.submit-button').on('mouseover', function () {
              window.signature.initialize();
              window.signature.animate();
            });
            */
            $('.submit-button').on('click', function () {
                window.signature.animate();
                if (!checking) setTimeout(function () {checking = false; check();}, 1000);
                checking = true;
            });
            //  $('.submit-button').on('mouseout', window.signature.initialize);
        });
    }.call(this));
          </script>
  
            
          </div>
        
          
          <div class="request-section split part-two">
            <h2>Patient ID</h2>
            <p>Patient surname: <span class="handwritten" id="patientlast">Surname</span></p>
            <p>Patient first name: <span class="handwritten" id="patientfirst">Firstname</span></p>
            <p>Gender: <span class="handwritten" id="patientgender">patient gender</span></p>
            <p>DOB: <span class="handwritten" id="patientdob">21-12-2010</span></p>
            <p>Patient identifier: <span class="handwritten" id="patientchi">81822192</span></p>
          </div>
        </div>
        <br>
          
        <br>
    
        <h3 style="text-align: center; color: transparent;">A hospital trust near you</h3>
      </div>

      </div>
  
  </div>
  
  
  <div data-role="page" id="badgedetails" data-theme="a">
      <div data-role="header" data-theme="a">
          <h1>Badge details</h1>
          <a data-role="button" href="#" data-rel="back">Back</a>
      </div>
      <div data-role="contents">
          <div class="badgebackground">
              <img src="" class="largebadge" id="badgeimage"/>
              <p id="badgedescription"></p>
              <h3>Criteria</h3>
              <p id="badgecriteria"></p>
              <h3>Tweet</h3>
              <p>Share your achievements with your colleagues!</p>
              <a href="https://twitter.com/intent/tweet?text=I have just unlocked a new award in the special blood components game!&url=http://optimalblooduse.eu/app/" data-theme="b" data-role="button">Tweet now</a>
              <br/><br/>
              <a href="#" data-role="button" data-rel="back">Return to badges</a>
          </div>
      </div>
  </div>

  
  <script type='text/javascript'>
  
    
  var badges = {
      "diamondoftime" : {
          "label" : "You have accurately prescribed five blood components in rapid succession!",
          "criteria" : "Five correct prescriptions within 10 minutes."
      },
      
      "haemoglobingemstone" : {
          "label" : "You have protected two patients with weaked immune systems due to drugs or treatments!",
          "criteria" : "Two correct prescriptions of irradiation.",
          "earned": true
      },
      
      "vialofplasma" : {
          "label" : "You have achieved cost-effective resource utilisation by consistently following guidelines.",
          "criteria" : "Two correct prescriptions of irradiation."
      },
      
      "cytomegaloring" : {
          "label" : "You have helped five patients avoid cytomegalovirus infection!",
          "criteria" : "Five correct prescriptions of CMV negative."
      },
      
      "irradiatoraward" : {
          "label" : "You have safeguarded ten patients from Graft versus Host Disease!",
          "criteria" : "ten correct prescriptions of Irradiation."
      },
      
      "rapidresponse" : {
          "label" : "You have come to a sound decision in under half a minute!",
          "criteria" : "One correct answer in under 30 seconds"
      },
      
      "granulocyteinactivator" : {
          "label" : "You have twarthed the risk of both GvHD and CMV infection at once!",
          "criteria" : "Correct answer to granulocyte question."
      },
      
      "plasmacannon" : {
          "label" : "You have correctly ordered plasma without attempting to irradiate or screen for cytomegalovirus.",
          "criteria" : "Correct answer to blood plasma question."
      },
      
      "redcellsaviour" : {
          "label" : "You have accurately prescribed CMV negative  red cells, thus preventing cytomegalovirus infection!",
          "criteria" : "Correct prescription of red cells to pregnant patient."
      },
      
      "plateletirradiator" : {
          "label" : "You have inactivated stray lymphocytes in a bag of platelets, thus preventing GvHD!",
          "criteria" : "Correct prescription of platelets to patient at risk of GvHD."
      },
      
      "indecisive" : {
          "label" : "You have requested more details when sufficient information was given.",
          "criteria" : "Incorrectly requesting more details."
      },
      
      "radioactivewaster" : {
          "label" : "You have twice ordered irradiated components when they were not required!",
          "criteria" : "Twice requesting irradiated products incorrectly."
      },
      
      "overcautious" : {
          "label" : "You have unnecessarily requested CMV negative components three times!",
          "criteria" : "Twice requesting CMV negative products inappropriately."
      },
      
      "cytomegalovirus" : {
          "label" : "You have omitted to request CMV negative components, putting the patient at risk of infection!",
          "criteria" : "Incorrectly prescribing cellular blood components without screening for CMV to patient at risk of CMV infection."
      },
      
      "graftversushostdisease" : {
          "label" : "You have failed to irradiate a component for a patient at risk of developing Graft versus Host Disease!",
          "criteria" : "Incorrectly prescribing cellular blood components without irradiation to a patient at risk of Graft versus Host Disease."
      }
  }
  
  var components = {
      "red blood cells": {
          "p":0.6,
          "cmv":"",
          "irradiation":""
      },    
      "platelets":{
          "p":0.4,
          "cmv":"",
          "irradiation":""
      },
      "fresh frozen plasma":{
          "p":0.3,
          "cmv": false,
          "irradiation": false
      },
      "cryoprecipitate":{
          "p":0.2,
          "cmv": false,
          "irradiation": false
      },
      "granulocytes":{
          "p":0.1,
          "cmv": true,
          "irradiation": true
      },
      "cryopreserved red cells":{
          "p":0.1,
          "cmv": "",
          "irradiation": false
      },
      "emergency red cells donated by a close family member":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      }
      /*
      "bone marrow":{
          "p":0.1,
          "cmv": false,
          "irradiation": false
      },
      "haemopoietic stem cells":{
          "p":0.1,
          "cmv": false,
          "irradiation": false
      }*/
  };
  
  var conditions = {    
      "Hodgkin's Lymphoma":{
          "p":0.2,
          "cmv": "",
          "irradiation": true
      },
      "neonatal alloimmune thrombocytopenia (NAIT)":{
          "p":0.2,
          "cmv": true,
          "irradiation": true,
          "baby" : true
      },
      "Aplastic Anaemia and has been treated with Anti-Thymocyte Globuline (ATG)":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },    
      "tested positive to HIV": {
          "p":0.1,
          "cmv": false,
          "irradiation": false
      },
      "a common viral infection": {
          "p":0.1,
          "cmv": false,
          "irradiation": false
      },
      "Leukaemia":{
          "p":0.1,
          "cmv": "",
          "irradiation": false
      },
      "SCID (Severe combined immunodeficiency)":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      },
      "DiGeorge syndrome":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      },
      "Wiskott Aldrich syndrome":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      },
      "Reticular dysgnesis":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      },
      "Adenosine deaminase (ADA) deficiency":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      },
      "Chronic mucosal candidiasis":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      },
      "Adenosine deaminase (ADA) deficiency":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      },
      "Major Histocompatibility Complex (MHC) class I- or class II-deficiency":{
          "p":0.05,
          "cmv": "",
          "irradiation": true
      }
  };
  
  
  var drugs = {    
      "alemtuzumab (Campath)":{
          "p":0.3,
          "cmv": "",
          "irradiation": true
      },
      
      "anti-thymocyte globuline (ATG)":{
          "p":0.2,
          "cmv": "",
          "irradiation": true
      },
      
      "fludarabine": {
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },    
      "cladribine":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "deoxycoformicin":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "bendamustine":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "clofarabine":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      }
  };
  
  
  var treatments = {    
      "an elective procedure in her third month of pregnancy":{
          "p":0.1,
          "cmv": true,
          "irradiation": "",
          "female": true
      },
      "intrauterine transfusion":{
          "p":0.1,
          "cmv": true,
          "irradiation": true,
          "baby" : true
      },
      "neontatal exchange transfusion":{
          "p":0.1,
          "cmv": true,
          "irradiation": true,
          "baby" : true
      },
      "routine infant 'top-up' and has no history of intrauterine transfusion (IUT)":{
          "p":0.1,
          "cmv": "",
          "irradiation": "",
          "baby" : true
      },
      "infant cardiac surgery and has no history of intrauterine transfusion (IUT)":{
          "p":0.1,
          "cmv": "",
          "irradiation": "",
          "baby" : true
      },
      "autologous bone marrow harvest":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "autologous peripheral blood stem cell harvest":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "autologous bone marrow transplant":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "autologous peripheral blood stem cell transplant":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "bone marrow donation":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "peripheral blood stem cell donation":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "allogeneic haemopoetic stem cell transplant":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      }
  };
  
  
  var histories = {    
      "intrauterine transfusion (IUT) in the past six months":{
          "p":0.1,
          "cmv": true,
          "irradiation": true,
          "baby" : true
      },
      "stem cell transplant in the past six months":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      },
      "bone marrow transplant in the past six months":{
          "p":0.1,
          "cmv": "",
          "irradiation": true
      }
  };
  
  
  
  // globals
  
  var currentQuestion = 0;
  
  
  
  
  function generateQuestions () {
      
      var questionBank = [];
      
      for (var i=0; i<100; i++) {
          
          var component = randomPick (components);
          var condition = randomPick (conditions);
          var drug = randomPick (drugs);
          var treatment = randomPick (treatments);
          var history = randomPick (histories);
          
          var questionPhrase = "";
          
          var firstFactor, secondFactor;
          
          var questionType = Math.floor(Math.random()*4) +1;
          
          switch (questionType) {
              case 1: // condition/diagnosis
                  questionPhrase = "How should " + component + " be transfused  to a patient who has " + condition + "?";
                  questionPhrase = "<patient> requires a transfusion with <strong>" + component + "</strong>. <pronoun> has <strong>" + condition + "</strong>."
                  firstFactor = condition;
                  secondFactor = conditions[condition];
                  break;
              case 2: // medication
                  questionPhrase = "How should " + component + " be supplied for a patient who is being treated with " + drug + "?";
                  questionPhrase = "<patient> requires a transfusion with <strong>" + component + "</strong>. <pronoun> is also receiving treatment with <strong>" + drug + "</strong>."
                  firstFactor = drug;
                  secondFactor = drugs[drug];
                  break;
              case 3: // treatment
                  questionPhrase = "How should " + component + " be administered to a patient who is undergoing " + treatment + "?";
                  questionPhrase = "<patient> requires a transfusion with <strong>" + component + "</strong>. <pronoun> is also undergoing <strong>" + treatment + "</strong>."
                  firstFactor = treatment;
                  secondFactor = treatments[treatment];
                  break;
              case 4: // history
                  questionPhrase = "How should " + component + " be administered to a patient who has undergone " + history + "?"; 
                  questionPhrase = "<patient> requires a transfusion with <strong>" + component + "</strong>. <pronoun> has undergone <strong>" + history + "</strong>."
                  firstFactor = history;
                  secondFactor = histories[history];
                  break;
          }
          
          //$("<p> " + (i+1) + ". " + questionPhrase +"</p>").appendTo($("#questions"));
          
          
          var cmv = (
              (
                  components[component].cmv
                  ||
                  secondFactor.cmv
              )
              && !(components[component].cmv === false)
          );
          
      
          // Logic for irradiation:
          
          var irr = (
              (
                  components[component].irradiation
                  ||
                  secondFactor.irradiation
              )
              && !(components[component].irradiation === false)
          );
          
          var answer = "notrequired";
      
          if (irr && cmv) answer = "irrcmv";
          else if (irr) answer = "irr";
          else if (cmv) answer = "cmv";
          
          questionBank[i] = {};
          questionBank[i].question = questionPhrase;
          questionBank[i].answer = answer;
          questionBank[i].component = component;
          questionBank[i].factor = firstFactor;
          questionBank[i].baby = secondFactor.baby || false;
          questionBank[i].female = secondFactor.female || false;
          
      }
      
      return (questionBank);
  }
  
  function randomPick (obj) {
      var totalprop = 0;
      for (item in obj) {
          totalprop += obj[item].p;
      }
      var chance = Math.random()*totalprop;
      var min = 0;
      var max = 0;
      for (item in obj) {
          max += obj[item].p;
          if (chance > min && chance < max){
              //obj[item].p -= 0.05;
              return(item);
          }
          min += obj[item].p;
      }
  }
  
  
  function generateBadgeView () {
    return;
      for (item in badges){
          var status = (badges[item].earned) ? "earned" : "";
          $('<img src="http://optimalblooduse.eu/app/badges/' + item + '.png" class="badge ' + status +'" id="'+item+'"/>').appendTo($("#container"));
          $("#"+item).bind("click", function(){
              viewBadge(this.id)
          });
      }
  }
  
  function viewBadge (badge) {
      //$("#badgetdetails").popup('open');
      $("#badgetitle").text(badges[badge].badge);
      $("#badgedescription").text(badges[badge].label);
      $("#badgecriteria").text(badges[badge].criteria);
      $("#badgeimage").attr("src", "http://optimalblooduse.eu/app/badges/" + badge + ".png");
      
      $.mobile.changePage('#badgedetails');
  }
  
  function toTitleCase(str) {
    return str.replace(/\w\S*/g, function(txt){
      return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
  }
  
  function makeLevel (level) {
      $('input:checkbox').removeAttr('checked');
      window.signature.initialize();
      window.scrollTo(0,0);
      $("#patientContainer").html('Loading new patient...');
      $("#questionContainer").html('Loading new question...');
      currentQuestion = rand(questions);
      var param = '';
      if (questions[currentQuestion].female) param = "&gender=female";
      $.ajax({
        url: 'https://randomuser.me/api/?nat=gb' + param,
        dataType: 'json',
        success: function(data){
          var first = toTitleCase(data.results[0].name.first);
          var last = toTitleCase(data.results[0].name.last);
          var title = toTitleCase(data.results[0].name.title.replace('monsieur', 'mr').replace('mademoiselle', 'ms'));
          var gender = data.results[0].gender;
          $("#patientlast").html(last);
          $("#patientfirst").html(first);
          $("#patientgender").html(gender);
          $("#bloodcomponent").html('1 x unit of ' + questions[currentQuestion].component);
          $("#patientchi").html(Math.round(Math.random() * 10000000000));
          
          
          var month = Math.round(Math.random() * 11) + 1
          var yearsOld = (Math.round(Math.random() * 33) + 18);
          var year = new Date().getFullYear() - yearsOld;
          if (questions[currentQuestion].baby) year = new Date().getFullYear() - 1;
          var day = Math.round(Math.random() * 29) + 1
          $("#patientdob").html(day + '-' + month + '-' + year);
          
          var age = questions[currentQuestion].baby ? 'baby' : 'adult';
          var genderLabel = gender === 'female' ? 'woman' : 'man';
          if (age == 'baby') {
            genderLabel = (gender === 'female' ? 'girl' : 'boy'); 
          }
          else age = yearsOld + " year old ";
          var name = "" + first + " " + last + " (" + age + " " + genderLabel + ")";
          var patientReference = age == 'baby' ? first : title + ". " + last;
          var pronoun = gender === "female" ? "She" : "He";
          var theQuestion = questions[currentQuestion].question.replace("<patient>", patientReference).replace("<pronoun>", pronoun);
          var imgurl = data.results[0].picture.large;
          if (age === 'baby') imgurl = "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c0/Human-Male-White-Newborn-Baby-Crying.jpg/320px-Human-Male-White-Newborn-Baby-Crying.jpg";
  
          $("#patientInfo").html( '<h3 style="margin:0.25em">' + name + '</h3><p style="margin:0.25em"> ' + theQuestion + '</p>');
          $("#patientPortrait").html( '<img class="portrait" src="' + imgurl + '">');
        }
      });
      
  }
  
  
  function check () {
    var rightAnswer = questions[currentQuestion].answer;
    
    var irradiated = $('#irrad').is(':checked');
    var cmv = $('#cmvneg').is(':checked');
    var hep = $('#hepe').is(':checked'); // not used
    
    var ans = 'notrequired';
  
    if (irradiated && cmv) ans = "irrcmv";
    else if (irradiated) ans ="irr";
    else if (cmv) ans = "cmv";
    
    //console.log(irradiated, cmv, ans, rightAnswer);
    
    if (ans == rightAnswer) {
      alert ("Correct!")
      makeLevel("level1");
      //var randomBadge = rand (badges);
      //badges[randomBadge].earned = true;
      //viewBadge (randomBadge);
    }
    else {
      alert("Wrong answer")
      makeLevel("level1");
    }
  }
  
  function rand (obj) {
      var i = 0;
      for (item in obj) i++;
      var randomNumber = Math.floor(Math.random()*i);
      i = 0;
      
      for (item in obj) {
          if (i == randomNumber) return (item);
          i++;
      }
  }
  
  
  $(".level").bind("click", function () {
      makeLevel (this.id);
      $.mobile.changePage('#levels');
  });
  
  $(".gameoption").bind("click", function () {
      answer (this.id);
  });
  
  
  $( "#levels" ).bind ( "pageshow", function( event ) {    
      makeLevel ("level1");
  });
  
  generateBadgeView ();
  var questions = generateQuestions();
  //console.log (questions[1]);
  
  </script>
</body>
</html>